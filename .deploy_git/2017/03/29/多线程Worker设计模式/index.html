<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="nWXA5pz9OB&quot;"><meta name="google-site-verification" content="GV1JH1LWgxtYEzh1ZspR37dC-o6YZWuEfgCQLPnAAMM"><link rel="icon" href="/favicon.png"><link rel="alternate" type="application/rss+xml" title="阿甘的博客" href="https://978420544.github.io/atom.xml"><link rel="stylesheet" href="/styles.css"><link rel="stylesheet" href="/my.css"><title>多线程Worker设计模式 | 阿甘的博客</title></head><body><div class="container"><div class="columns page-header"><h1>阿甘的博客</h1></div><div class="columns"><div class="navigation"><nav class="menus-main"><a href="/" class="favicon"><img alt="阿甘的博客" src="/favicon.png"></a><a href="/">首页</a><a href="/archives">归档</a><a href="/resume">简历</a><a href="/about">关于</a></nav><nav class="right menus-right"><a href="/atom.xml">RSS</a><a target="_blank" href="https://github.com/978420544">fork on Github</a></nav></div></div><div class="columns"><div class="block-body column three-fourths"><div class="article-widget"><a href="https://github.com/978420544">《斗破苍穹》三十年河西三十年河东，莫欺少年穷！</a><span id="busuanzi_container_site_pv">总访问量&nbsp&nbsp<span id="busuanzi_value_site_pv"></span><br>总访客数&nbsp&nbsp<span id="busuanzi_value_site_uv"></span></span></div><article><header><small class="right"><a target="_blank" href="https://github.com/978420544/978420544.github.io/tree/source/source/_posts%2F%E5%A4%9A%E7%BA%BF%E7%A8%8BWorker%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.md">查看源代码</a></small><h1>多线程Worker设计模式</h1></header><div class="article-meta clearfix"><time class="left">2017-03-29</time><ul class="tags left"><li><a href="/categories/java/">Java</a></li></ul><time class="right"><span id="busuanzi_container_page_pv">&nbsp&nbsp<span id="busuanzi_value_page_pv"></span></span></time><ul class="tags right"><li><a href="/tags/java/">Java</a></li><li><a href="/tags/thread/">多线程</a></li></ul></div><div class="markdown-body"><p>关于Worker设计模式文章的撰写，博主是仔细实验了阿里中间件博客的一片文章—— <a href="http://jm.taobao.org/2012/09/20/java-worker-design/" target="_blank" rel="external">Java Worker 设计模式</a>，这篇文章主要讲了Worker设计模式的三种更为便捷的设计方法：简单的Worker设计模式，多级优先级队列流水线模式，Map2Reduce流水线模式。不过博主将在本篇文章中分享一下自己的理解，和自己的一些应用。</p>
<hr>
<h3 id="简单的Worker模式–Master2Worker模式"><a href="#简单的Worker模式–Master2Worker模式" class="headerlink" title="简单的Worker模式–Master2Worker模式"></a>简单的Worker模式–Master2Worker模式</h3><p>Master2Worker模式是比较常见的并行多线程模式之一。系统主要由两类进程协同工作即Master进程和Worker进程，Master进程负责接收外部的任务和分配任务，管理Woker队列和任务队列，Worker负责处理子任务，包含具体的任务逻辑，Worker完成后将结果返回给Master，有Master分支汇总返回给具体的调用端，处理流程如下所示：</p>
<center><img src="/images/process.png" alt="Master2Worker"></center>

<h4 id="基于Idea的类图如下"><a href="#基于Idea的类图如下" class="headerlink" title="基于Idea的类图如下"></a>基于Idea的类图如下</h4><center><img src="/images/Master2Worker.png" alt="Master2Worker"></center>

<h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.demo.master2worker;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Queue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Master</span> </span>&#123;</div><div class="line">	<span class="comment">// 任务队列</span></div><div class="line">	<span class="keyword">protected</span> Queue&lt;Object&gt; workQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Object&gt;();</div><div class="line">	<span class="comment">// Worker进程队列</span></div><div class="line">	<span class="keyword">protected</span> Map&lt;String, Thread&gt; threadMap = <span class="keyword">new</span> HashMap&lt;String, Thread&gt;();</div><div class="line">	<span class="comment">// 子任务处理结果集</span></div><div class="line">	<span class="keyword">protected</span> Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Master</span><span class="params">(Worker worker, <span class="keyword">int</span> countWorker)</span> </span>&#123;</div><div class="line">		worker.setWorkQueue(workQueue);</div><div class="line">		worker.setResultMap(resultMap);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; countWorker; i++) &#123;</div><div class="line">			threadMap.put(Integer.toString(i), <span class="keyword">new</span> Thread(worker, Integer.toString(i)));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 是否所有的子任务都介绍了</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, Thread&gt; entry : threadMap.entrySet()) &#123;</div><div class="line">			<span class="keyword">if</span> (entry.getValue().getState() != Thread.State.TERMINATED)</div><div class="line">				<span class="comment">// 存在为完成的线程</span></div><div class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 提交一个子任务</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Object job)</span> </span>&#123;</div><div class="line">		workQueue.add(job);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 返回子任务结果集</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getResultMap</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> resultMap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 执行所有Worker进程，进行处理</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, Thread&gt; entry : threadMap.entrySet()) &#123;</div><div class="line">			entry.getValue().start();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Queue;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	<span class="comment">// 任务队列</span></div><div class="line">	<span class="keyword">protected</span> Queue&lt;Object&gt; workQueue;</div><div class="line">	<span class="comment">// 子任务处理结果集</span></div><div class="line">	<span class="keyword">protected</span> Map&lt;String, Object&gt; resultMap;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWorkQueue</span><span class="params">(Queue&lt;Object&gt; workQueue)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.workQueue = workQueue;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResultMap</span><span class="params">(Map&lt;String, Object&gt; resultMap)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.resultMap = resultMap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 子任务处理的逻辑，在这里不作具体实现，由子类实现</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(Object input)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> input;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">			<span class="comment">// 获取子任务</span></div><div class="line">			Object input = workQueue.poll();</div><div class="line">			<span class="keyword">if</span> (input == <span class="keyword">null</span>)</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="comment">// 处理子任务</span></div><div class="line">			Object re = handle(input);</div><div class="line">			<span class="comment">// 将处理结果写入结果集</span></div><div class="line">			resultMap.put(Integer.toString(input.hashCode()), re);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="PlusWorker"><a href="#PlusWorker" class="headerlink" title="PlusWorker"></a>PlusWorker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlusWorker</span> <span class="keyword">extends</span> <span class="title">Worker</span> </span>&#123; <span class="comment">// 求立方和</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(Object input)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> i = (Integer) input;</div><div class="line">		<span class="keyword">return</span> i * i * i;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// 固定使用4个Workde</span></div><div class="line">		Master master = <span class="keyword">new</span> Master(<span class="keyword">new</span> PlusWorker(), <span class="number">4</span>);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++)</div><div class="line">			<span class="comment">// 提交100个子任务</span></div><div class="line">			master.submit(i);</div><div class="line">		master.execute(); <span class="comment">// 开始计算</span></div><div class="line"></div><div class="line">		Map&lt;String, Object&gt; resultMap = master.getResultMap();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> re = <span class="number">0</span>; <span class="comment">// 最终计算结果保存在此</span></div><div class="line">		<span class="comment">// 不需要等待所有Worker都执行完即可</span></div><div class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">			Set&lt;String&gt; keys = resultMap.keySet(); <span class="comment">// 开始计算最终结果</span></div><div class="line">			String key = <span class="keyword">null</span>;</div><div class="line">			<span class="keyword">for</span> (String k : keys) &#123;</div><div class="line">				key = k;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			Integer i = <span class="keyword">null</span>;</div><div class="line">			<span class="keyword">if</span> (key != <span class="keyword">null</span>)</div><div class="line">				i = (Integer) resultMap.get(key);</div><div class="line">			<span class="keyword">if</span> (i != <span class="keyword">null</span>)</div><div class="line">				re += i; <span class="comment">// 最终结果</span></div><div class="line">			<span class="keyword">if</span> (key != <span class="keyword">null</span>)</div><div class="line">				resultMap.remove(key); <span class="comment">// 移除已被计算过的项目</span></div><div class="line">			<span class="keyword">if</span> (master.isComplete() &amp;&amp; resultMap.size() == <span class="number">0</span>)</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		System.out.println(re);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="流程描述"><a href="#流程描述" class="headerlink" title="流程描述"></a>流程描述</h4><p>Application，初始化Master进程，通过构造函数绑定Worker的具体实现，作为客户端提交100个任务到Master进程，然后开始执行Master进程。<br>Master进程将任务都加入workerQuene，然后将workerQuene交给Worker实例，然后将Worker实例加入到设置的所有线程中，execute之后开始Start线程，所有的实例都是用同一个队列poll新的任务进行计算，然后将任务添加到resultMap中，并且一个线程并不需要等待其他任务的完成即可进行下一个任务。<br>Application,通过一个循环读取计算结果，读取完之后，删除读取过的结果，直至所有的任务完成，并且读取完所有的计算结果，并进程计算。</p>
<hr>
<h3 id="多级优先级队列流水线模式"><a href="#多级优先级队列流水线模式" class="headerlink" title="多级优先级队列流水线模式"></a>多级优先级队列流水线模式</h3><h4 id="BlockingQueue-阻塞队列"><a href="#BlockingQueue-阻塞队列" class="headerlink" title="BlockingQueue 阻塞队列"></a>BlockingQueue 阻塞队列</h4><p>BlockingQueue是一个阻塞的队列，当队列满时，会阻塞程序运行，直至有空余的位置等待添加。</p>
<h4 id="PriorityQueue-优先级队列"><a href="#PriorityQueue-优先级队列" class="headerlink" title="PriorityQueue 优先级队列"></a>PriorityQueue 优先级队列</h4><p>Java util包中的PriorityQueue类用来表示优先队列。优先队列是一个以集合为基础的抽象数据类型，队列中的每个元素都有一个优先级值。优先级值用来表示该元素的出列的优先级。</p>
<h4 id="流水线模式"><a href="#流水线模式" class="headerlink" title="流水线模式"></a>流水线模式</h4><p>就像生产车间上的流水线工人一样，将任务切分成几个小块，每个worker负责自己的一部分，以提高整体的生产、产出效率。<br>假设完成任务 t 需要的时间为：W(t)=n，那么将任务分解成m份，流水线式的执行，每小份需要的时间便为 W(t/m)=n/m，那么执行1000条任务的时间，单个为1000n，流水线长度为L，则用这种方式所用的时间为(1000-1)(m-L+1)n/m+n<br>其中L&lt;m，由此可见，流水线的worker越多、任务越细分，工作的效率将越高。这种主方式的问题在于，如果一个worker出现问题，那么整个流水线就将停止工作。而且任务的优先级不能动态调用，必须事先告知。</p>
<h4 id="多级反馈队列"><a href="#多级反馈队列" class="headerlink" title="多级反馈队列"></a>多级反馈队列</h4><p>这是一个有Q1、Q2…Qn个多重流水线方式，从高到低分别代码不同的优先级，高优先级的worker要多于低优先级的，一般是2的倍数，即Q4有16个worker、Q3有8个，后面类推。任务根据预先估计好的优先级进入，如果任务在某步的执行过长，直接踢到下一级，让出最快的资源。<br>显然这种方式的好处就在于可以动态地调整任务的优级，及时做出反应。当然，为了实现更好的高度，我们可以在低级里增加一个阀值，使得放偶然放入低级的task可以有复活的机会。</p>
<h4 id="模式简介"><a href="#模式简介" class="headerlink" title="模式简介"></a>模式简介</h4><p>此模式由ConfigurableWorker做任务队列和Worker的管理，抽象的任务WorkerTask，任务处理逻辑TaskProcesor，监听器WorkerListener组成，优先级队列请实现对应的Comparable接口。</p>
<p>ConfigurableWorker管理任务队列和Worker的生命周期，然后生成对应的处理逻辑，监听器监听任务的完成情况，反馈给ConfigurableWorker。下面仅贴出抽象的代码，具体的实现逻辑祥见 <a href="https://github.com/sefler1987/javaworker" target="_blank" rel="external">JavaWorker</a>。</p>
<h4 id="基于Idea的类图如下-1"><a href="#基于Idea的类图如下-1" class="headerlink" title="基于Idea的类图如下"></a>基于Idea的类图如下</h4><center><img src="/images/priorityQueue.png" alt="Master2Worker"></center>

<h5 id="针对类图的详述"><a href="#针对类图的详述" class="headerlink" title="针对类图的详述"></a>针对类图的详述</h5><p>ConfigurableWorker：要实现自我生命周期管理，需要实现Runable，这样其才能以单独的线程运行，使用daemon线程的方式运行。<br>worker里面还包括几个其它成员：taskQueue，一个阻塞性质的queue，一般BlockingArrayList就可以了，这样任务是FIFO（先进先出）的，如果要考虑任务的优先级，则可以考虑使用PriorityBlockingQueue；<br>listeners，根据事件进行划分的事件监听者，以便于当一个任务完成的时候进行处理，需要注意的是，为了较高效地进行listener遍历，这里我推荐使用CopyOnWriteArrayList，免得每次都复制。<br>WorkerTask：实际上这是一个抽象的工内容，其包括基本的id与，task的ID是Worker生成的，相当于递wtte后的一个执回，当数据执行完了的时候需要使用这个id来取结果。而后面真正实现的实体task则包含任务处理时需要的数据。<br>Processor：实现处理加工传入的task数据，加工完成后触发fireEvent（WorkerEvent.TASK_COMPLETE）事件，之后通过Future的get即可得到最终的数据。<br>通过ConfigurableWorker的管理，可随时更换具体的Processor和Task，可实现对应的流水线式的处理和Map2Reduce流水处理，可以添加不同的Listener进行不同的监听，可以使用concurrent包下面的map、list防止对应的并发问题。</p>
<h4 id="WorkTask"><a href="#WorkTask" class="headerlink" title="WorkTask"></a>WorkTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.Future;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerTask</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Future</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">protected</span> String taskID;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> priority;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WorkerTask</span><span class="params">(<span class="keyword">int</span> priority)</span> </span>&#123;</div><div class="line">        taskID = SimpleTaskIDGenerator.genTaskID();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTaskID</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> taskID;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTaskID</span><span class="params">(String taskID)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.taskID = taskID;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPriority</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> priority;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPriority</span><span class="params">(<span class="keyword">int</span> priority)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.priority = priority;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> done;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDone</span><span class="params">(<span class="keyword">boolean</span> done)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.done = done;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="WorkEvent"><a href="#WorkEvent" class="headerlink" title="WorkEvent"></a>WorkEvent</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> WorkerEvent &#123;</div><div class="line">    TASK_COMPLETE,</div><div class="line">    TASK_FAILED;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="WorkListener"><a href="#WorkListener" class="headerlink" title="WorkListener"></a>WorkListener</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.majingyang.qctry.flowworker.WorkerEvent;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WorkerListener</span> </span>&#123;</div><div class="line">    <span class="function">List&lt;WorkerEvent&gt; <span class="title">intrests</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(WorkerEvent event, Object... args)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="TaskProcessor"><a href="#TaskProcessor" class="headerlink" title="TaskProcessor"></a>TaskProcessor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskProcessor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(WorkerTask&lt;?&gt; task)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ConfigurableWorker"><a href="#ConfigurableWorker" class="headerlink" title="ConfigurableWorker"></a>ConfigurableWorker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.majingyang.qctry.flowworker.WorkerEvent;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurableWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">LifeCycle</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> BlockingQueue&lt;WorkerTask&lt;?&gt;&gt; taskQueue = <span class="keyword">new</span> </div><div class="line"></div><div class="line">ArrayBlockingQueue&lt;WorkerTask&lt;?&gt;&gt;(<span class="number">5</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Thread thread;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> HashMap&lt;WorkerEvent, CopyOnWriteArrayList&lt;WorkerListener&gt;&gt; listenerMap;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TaskProcessor taskProcessor;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> initiated = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String workerID;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfigurableWorker</span><span class="params">(String workerID)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.workerID = workerID;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!initiated) &#123;</div><div class="line">            init();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        thread.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (initiated)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (taskProcessor == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Task Processor must be set first"</span>);</div><div class="line"></div><div class="line">        thread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);</div><div class="line">        thread.setDaemon(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        listenerMap = <span class="keyword">new</span> HashMap&lt;WorkerEvent, CopyOnWriteArrayList&lt;WorkerListener&gt;&gt;();</div><div class="line"></div><div class="line">        initiated = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">        thread.interrupt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(WorkerEvent event, Object... args)</span> </span>&#123;</div><div class="line">        CopyOnWriteArrayList&lt;WorkerListener&gt; listeners = listenerMap.get(event);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (listeners == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (WorkerListener listener : listeners) &#123;</div><div class="line">            listener.onEvent(event, args);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(WorkerListener listener)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!initiated) &#123;</div><div class="line">            init();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        List&lt;WorkerEvent&gt; intrestEvents = listener.intrests();</div><div class="line">        <span class="keyword">for</span> (WorkerEvent event : intrestEvents) &#123;</div><div class="line">            CopyOnWriteArrayList&lt;WorkerListener&gt; listeners = listenerMap.get(event);</div><div class="line">            <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123;</div><div class="line">                listeners = <span class="keyword">new</span> CopyOnWriteArrayList&lt;WorkerListener&gt;();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            listeners.add(listener);</div><div class="line">            listenerMap.put(event, listeners);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addTask</span><span class="params">(WorkerTask&lt;?&gt; task)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!initiated) &#123;</div><div class="line">            init();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            taskQueue.put(task);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            thread.interrupt();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> task.getTaskID();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                WorkerTask&lt;?&gt; task = taskQueue.take();</div><div class="line"></div><div class="line">                taskProcessor.process(task);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (task.isDone()) &#123;</div><div class="line">                    fireEvent(WorkerEvent.TASK_COMPLETE, task);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                fireEvent(WorkerEvent.TASK_FAILED, task);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            System.out.println(<span class="string">"Worker mission canceled, remaining task size: "</span> + </div><div class="line"></div><div class="line">taskQueue.size());</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> TaskProcessor <span class="title">getTaskProcessor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> taskProcessor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTaskProcessor</span><span class="params">(TaskProcessor taskProcessor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.taskProcessor = taskProcessor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getWorkerID</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> workerID;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="LinearURLMiningMain"><a href="#LinearURLMiningMain" class="headerlink" title="LinearURLMiningMain"></a>LinearURLMiningMain</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentSkipListSet;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.ConfigurableWorker;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.SimpleURLComparator;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerListener;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerTask;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.linear.PageURLMiningProcessor;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.linear.PageURLMiningTask;</div><div class="line"><span class="keyword">import</span> com.majingyang.qctry.flowworker.WorkerEvent;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinearURLMiningMain</span> <span class="keyword">implements</span> <span class="title">WorkerListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EMPTY_STRING = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> URL_SIZE_TO_MINE = <span class="number">10000</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, WorkerTask&lt;?&gt;&gt; taskID2TaskMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, WorkerTask&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentSkipListSet&lt;String&gt; foundURLs = <span class="keyword">new</span> ConcurrentSkipListSet&lt;String&gt;(<span class="keyword">new</span> SimpleURLComparator());</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</div><div class="line"></div><div class="line">        ConfigurableWorker worker = <span class="keyword">new</span> ConfigurableWorker(<span class="string">"W001"</span>);</div><div class="line">        worker.setTaskProcessor(<span class="keyword">new</span> PageURLMiningProcessor());</div><div class="line"></div><div class="line">        addTask2Worker(worker, <span class="keyword">new</span> PageURLMiningTask(<span class="string">"http://www.taobao.com"</span>));</div><div class="line">        addTask2Worker(worker, <span class="keyword">new</span> PageURLMiningTask(<span class="string">"http://www.xinhuanet.com"</span>));</div><div class="line">        addTask2Worker(worker, <span class="keyword">new</span> PageURLMiningTask(<span class="string">"http://www.zol.com.cn"</span>));</div><div class="line">        addTask2Worker(worker, <span class="keyword">new</span> PageURLMiningTask(<span class="string">"http://www.163.com"</span>));</div><div class="line"></div><div class="line">        LinearURLMiningMain mainListener = <span class="keyword">new</span> LinearURLMiningMain();</div><div class="line">        worker.addListener(mainListener);</div><div class="line"></div><div class="line">        worker.start();</div><div class="line"></div><div class="line">        String targetURL = EMPTY_STRING;</div><div class="line">        <span class="keyword">while</span> (foundURLs.size() &lt; URL_SIZE_TO_MINE) &#123;</div><div class="line">            targetURL = foundURLs.pollFirst();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (targetURL == <span class="keyword">null</span>) &#123;</div><div class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            PageURLMiningTask task = <span class="keyword">new</span> PageURLMiningTask(targetURL);</div><div class="line">            taskID2TaskMap.putIfAbsent(worker.addTask(task), task);</div><div class="line"></div><div class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        worker.stop();</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (String string : foundURLs) &#123;</div><div class="line">            System.out.println(string);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"Time Cost: "</span> + (System.currentTimeMillis() - startTime) + <span class="string">"ms"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addTask2Worker</span><span class="params">(ConfigurableWorker mapWorker_1, PageURLMiningTask task)</span> </span>&#123;</div><div class="line">        String taskID = mapWorker_1.addTask(task);</div><div class="line">        taskID2TaskMap.put(taskID, task);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;WorkerEvent&gt; <span class="title">intrests</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Arrays.asList(WorkerEvent.TASK_COMPLETE, WorkerEvent.TASK_FAILED);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(WorkerEvent event, Object... args)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (WorkerEvent.TASK_FAILED == event) &#123;</div><div class="line">            System.err.println(<span class="string">"Error while extracting URLs"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (WorkerEvent.TASK_COMPLETE != event)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        PageURLMiningTask task = (PageURLMiningTask) args[<span class="number">0</span>];</div><div class="line">        <span class="keyword">if</span> (!taskID2TaskMap.containsKey(task.getTaskID()))</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        foundURLs.addAll(task.getMinedURLs());</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"Found URL size: "</span> + foundURLs.size());</div><div class="line"></div><div class="line">        taskID2TaskMap.remove(task.getTaskID());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Map2ReduceWorker设计模式"><a href="#Map2ReduceWorker设计模式" class="headerlink" title="Map2ReduceWorker设计模式"></a>Map2ReduceWorker设计模式</h3><p>Map2ReduceWorker设计模式基于Google的MapReduce实现提高分布式效率的算法实现，有很好的并行执行效率。<br>针对这样的Worker设计模式，我们基于以上的Worker模式，使用基于Map和Reduce的Processor进行处理，这样可以避免串行的流水线模式一个任务失败，将导致所有的任务失败的漏洞。基于这样的模式我们建立多个基于ConfigurableWorker的Map进程，建立多个基于ConfigurableWorker的Reduce进程，设置管理并行任务的Connector监听器，当任何一个Map完成的时候就会添加到Reduce的任务队列中等待执行，Reduce将poll到任务进行后续逻辑处理。</p>
<h4 id="处理示意图"><a href="#处理示意图" class="headerlink" title="处理示意图"></a>处理示意图</h4><center><img src="/images/Map2Reduce.png" alt=""></center>

<h4 id="Map2ReduceConnector-监听Map完成，加入Reduce队列"><a href="#Map2ReduceConnector-监听Map完成，加入Reduce队列" class="headerlink" title="Map2ReduceConnector(监听Map完成，加入Reduce队列)"></a>Map2ReduceConnector(监听Map完成，加入Reduce队列)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.ConfigurableWorker;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerListener;</div><div class="line"><span class="keyword">import</span> com.majingyang.qctry.flowworker.WorkerEvent;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Map2ReduceConnector</span> <span class="keyword">implements</span> <span class="title">WorkerListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> List&lt;ConfigurableWorker&gt; reduces = <span class="keyword">new</span> ArrayList&lt;ConfigurableWorker&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> lastIndex = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Map2ReduceConnector</span><span class="params">(List&lt;ConfigurableWorker&gt; reduces)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.reduces.addAll(reduces);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;WorkerEvent&gt; <span class="title">intrests</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Arrays.asList(WorkerEvent.TASK_COMPLETE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(WorkerEvent event, Object... args)</span> </span>&#123;</div><div class="line">        MapReducePageURLMiningTask task = (MapReducePageURLMiningTask) args[<span class="number">0</span>];</div><div class="line"></div><div class="line">        lastIndex = ++lastIndex % reduces.size();</div><div class="line">        reduces.get(lastIndex).addTask(task);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="MapReducePageURLMiningTask-Map2ReduceTask"><a href="#MapReducePageURLMiningTask-Map2ReduceTask" class="headerlink" title="MapReducePageURLMiningTask(Map2ReduceTask)"></a>MapReducePageURLMiningTask(Map2ReduceTask)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.HashSet;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerTask;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReducePageURLMiningTask</span> <span class="keyword">extends</span> <span class="title">WorkerTask</span>&lt;<span class="title">HashSet</span>&lt;<span class="title">String</span>&gt;&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_PRIORITY = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> HashSet&lt;String&gt; minedURLs = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String pageContent;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String targetURL;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapReducePageURLMiningTask</span><span class="params">(String targetURL)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(NO_PRIORITY);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.targetURL = targetURL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Not implemented yet"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Not implemented yet"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> HashSet&lt;String&gt; <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isDone()) &#123;</div><div class="line">            wait();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> minedURLs;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> HashSet&lt;String&gt; <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException,</span></div><div class="line">            ExecutionException, TimeoutException &#123;</div><div class="line">        <span class="keyword">if</span> (!isDone()) &#123;</div><div class="line">            wait(unit.toMillis(timeout));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> minedURLs;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> HashSet&lt;String&gt; <span class="title">getMinedURLs</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> minedURLs;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMinedURL</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">        minedURLs.add(url);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTargetURL</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> targetURL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTargetURL</span><span class="params">(String targetURL)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.targetURL = targetURL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPageContent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pageContent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPageContent</span><span class="params">(String pageContent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.pageContent = pageContent;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="MapReduceURLMiningMain-主任务监听器和程序入口"><a href="#MapReduceURLMiningMain-主任务监听器和程序入口" class="headerlink" title="MapReduceURLMiningMain(主任务监听器和程序入口)"></a>MapReduceURLMiningMain(主任务监听器和程序入口)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.TreeSet;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.ConfigurableWorker;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.SimpleURLComparator;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerListener;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerTask;</div><div class="line"><span class="keyword">import</span> com.majingyang.qctry.flowworker.WorkerEvent;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceURLMiningMain</span> <span class="keyword">implements</span> <span class="title">WorkerListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> URL_SIZE_TO_MINE = <span class="number">5000</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, WorkerTask&lt;?&gt;&gt; taskID2TaskMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, WorkerTask&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TreeSet&lt;String&gt; foundURLs = <span class="keyword">new</span> TreeSet&lt;String&gt;(<span class="keyword">new</span> SimpleURLComparator());</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="comment">// four mapers</span></div><div class="line">        List&lt;ConfigurableWorker&gt; mappers = <span class="keyword">new</span> ArrayList&lt;ConfigurableWorker&gt;(<span class="number">4</span>);</div><div class="line"></div><div class="line">        ConfigurableWorker mapWorker_1 = <span class="keyword">new</span> ConfigurableWorker(<span class="string">"W_M1"</span>);</div><div class="line">        ConfigurableWorker mapWorker_2 = <span class="keyword">new</span> ConfigurableWorker(<span class="string">"W_M2"</span>);</div><div class="line">        ConfigurableWorker mapWorker_3 = <span class="keyword">new</span> ConfigurableWorker(<span class="string">"W_M3"</span>);</div><div class="line">        ConfigurableWorker mapWorker_4 = <span class="keyword">new</span> ConfigurableWorker(<span class="string">"W_M4"</span>);</div><div class="line">        mapWorker_1.setTaskProcessor(<span class="keyword">new</span> PageContentFetchProcessor());</div><div class="line">        mapWorker_2.setTaskProcessor(<span class="keyword">new</span> PageContentFetchProcessor());</div><div class="line">        mapWorker_3.setTaskProcessor(<span class="keyword">new</span> PageContentFetchProcessor());</div><div class="line">        mapWorker_4.setTaskProcessor(<span class="keyword">new</span> PageContentFetchProcessor());</div><div class="line"></div><div class="line">        mappers.add(mapWorker_1);</div><div class="line">        mappers.add(mapWorker_2);</div><div class="line">        mappers.add(mapWorker_3);</div><div class="line">        mappers.add(mapWorker_4);</div><div class="line"></div><div class="line">        <span class="comment">// one reducers</span></div><div class="line">        ConfigurableWorker reduceWorker_1 = <span class="keyword">new</span> ConfigurableWorker(<span class="string">"W_R1"</span>);</div><div class="line">        reduceWorker_1.setTaskProcessor(<span class="keyword">new</span> URLMatchingProcessor());</div><div class="line"></div><div class="line">        <span class="comment">// bind reducer to final result class</span></div><div class="line">        MapReduceURLMiningMain main = <span class="keyword">new</span> MapReduceURLMiningMain();</div><div class="line">        reduceWorker_1.addListener(main);</div><div class="line"></div><div class="line">        <span class="comment">// initiate tasks</span></div><div class="line">        addTask2Worker(mapWorker_1, <span class="keyword">new</span> MapReducePageURLMiningTask(<span class="string">"http://www.taobao.com"</span>));</div><div class="line">        addTask2Worker(mapWorker_1, <span class="keyword">new</span> MapReducePageURLMiningTask(<span class="string">"http://www.xinhuanet.com"</span>));</div><div class="line">        addTask2Worker(mapWorker_1, <span class="keyword">new</span> MapReducePageURLMiningTask(<span class="string">"http://www.zol.com.cn"</span>));</div><div class="line">        addTask2Worker(mapWorker_1, <span class="keyword">new</span> MapReducePageURLMiningTask(<span class="string">"http://www.163.com"</span>));</div><div class="line"></div><div class="line">        <span class="comment">// bind mapper to reduer</span></div><div class="line">        Map2ReduceConnector connector = <span class="keyword">new</span> Map2ReduceConnector(Arrays.asList(reduceWorker_1));</div><div class="line">        mapWorker_1.addListener(connector);</div><div class="line">        mapWorker_2.addListener(connector);</div><div class="line">        mapWorker_3.addListener(connector);</div><div class="line">        mapWorker_4.addListener(connector);</div><div class="line"></div><div class="line">        <span class="comment">// start all</span></div><div class="line">        mapWorker_1.start();</div><div class="line">        mapWorker_2.start();</div><div class="line">        mapWorker_3.start();</div><div class="line">        mapWorker_4.start();</div><div class="line">        reduceWorker_1.start();</div><div class="line"></div><div class="line">        String targetURL = <span class="string">""</span>;</div><div class="line">        <span class="keyword">int</span> lastIndex = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (foundURLs.size() &lt; URL_SIZE_TO_MINE) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (foundURLs) &#123;</div><div class="line">                targetURL = foundURLs.pollFirst();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (targetURL == <span class="keyword">null</span>) &#123;</div><div class="line">                    foundURLs.wait();</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            lastIndex = ++lastIndex % mappers.size();</div><div class="line">            MapReducePageURLMiningTask task = <span class="keyword">new</span> MapReducePageURLMiningTask(targetURL);</div><div class="line">            taskID2TaskMap.putIfAbsent(mappers.get(lastIndex).addTask(task), task);</div><div class="line"></div><div class="line">            <span class="keyword">synchronized</span> (foundURLs) &#123;</div><div class="line">                foundURLs.add(targetURL);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// stop all</span></div><div class="line">        mapWorker_1.stop();</div><div class="line">        mapWorker_2.stop();</div><div class="line">        mapWorker_3.stop();</div><div class="line">        mapWorker_4.stop();</div><div class="line">        reduceWorker_1.stop();</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (foundURLs) &#123;</div><div class="line">            <span class="keyword">for</span> (String string : foundURLs) &#123;</div><div class="line">                System.out.println(string);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"Time Cost: "</span> + (System.currentTimeMillis() - startTime) + <span class="string">"ms"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addTask2Worker</span><span class="params">(ConfigurableWorker mapWorker_1, MapReducePageURLMiningTask task)</span> </span>&#123;</div><div class="line">        String taskID = mapWorker_1.addTask(task);</div><div class="line">        taskID2TaskMap.put(taskID, task);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;WorkerEvent&gt; <span class="title">intrests</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Arrays.asList(WorkerEvent.TASK_COMPLETE, WorkerEvent.TASK_FAILED);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(WorkerEvent event, Object... args)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (WorkerEvent.TASK_FAILED == event) &#123;</div><div class="line">            System.err.println(<span class="string">"Error while extracting URLs"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (WorkerEvent.TASK_COMPLETE != event)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        MapReducePageURLMiningTask task = (MapReducePageURLMiningTask) args[<span class="number">0</span>];</div><div class="line">        <span class="keyword">if</span> (!taskID2TaskMap.containsKey(task.getTaskID()))</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (foundURLs) &#123;</div><div class="line">            foundURLs.addAll(task.getMinedURLs());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"Found URL size: "</span> + foundURLs.size());</div><div class="line"></div><div class="line">        taskID2TaskMap.remove(task.getTaskID());</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (foundURLs) &#123;</div><div class="line">            <span class="comment">// notify the static main method above</span></div><div class="line">            foundURLs.notifyAll();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="PageContentFetchProcessor-MapProcessor"><a href="#PageContentFetchProcessor-MapProcessor" class="headerlink" title="PageContentFetchProcessor(MapProcessor)"></a>PageContentFetchProcessor(MapProcessor)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLConnection;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.TaskProcessor;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerTask;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageContentFetchProcessor</span> <span class="keyword">implements</span> <span class="title">TaskProcessor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_PAGE_SIZE = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">10</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">128</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WorkerTask&lt;?&gt; task)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!(task <span class="keyword">instanceof</span> MapReducePageURLMiningTask))</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Excepted PageURLMiningTask but was: "</span> + task.getClass().getSimpleName());</div><div class="line"></div><div class="line">        MapReducePageURLMiningTask mapReduceURLMiningTask = (MapReducePageURLMiningTask) task;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            URL url = <span class="keyword">new</span> URL(mapReduceURLMiningTask.getTargetURL());</div><div class="line"></div><div class="line">            URLConnection urlConnection = url.openConnection();</div><div class="line">            urlConnection.setConnectTimeout((<span class="keyword">int</span>) TimeUnit.SECONDS.toMillis(<span class="number">2</span>));</div><div class="line">            urlConnection.setReadTimeout((<span class="keyword">int</span>) TimeUnit.SECONDS.toMillis(<span class="number">2</span>));</div><div class="line"></div><div class="line">            InputStream inputStream = urlConnection.getInputStream();</div><div class="line">            BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream), BUFFER_SIZE);</div><div class="line"></div><div class="line">            StringBuilder pageContent = <span class="keyword">new</span> StringBuilder();</div><div class="line"></div><div class="line">            String line = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">                pageContent.append(line);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (line.length() &gt; MAX_PAGE_SIZE || pageContent.length() &gt; MAX_PAGE_SIZE) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mapReduceURLMiningTask.setPageContent(pageContent.toString());</div><div class="line">            mapReduceURLMiningTask.setDone(<span class="keyword">true</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            System.err.println(<span class="string">"Error while fetching specified URL: "</span> + mapReduceURLMiningTask.getTargetURL()</div><div class="line">                    + <span class="string">"\nException"</span> + e.toString());</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">synchronized</span> (mapReduceURLMiningTask) &#123;</div><div class="line">                mapReduceURLMiningTask.notifyAll();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="URLMatchingProcessor-ReduceProcessor"><a href="#URLMatchingProcessor-ReduceProcessor" class="headerlink" title="URLMatchingProcessor(ReduceProcessor)"></a>URLMatchingProcessor(ReduceProcessor)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.regex.Matcher;</div><div class="line"><span class="keyword">import</span> java.util.regex.Pattern;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.TaskProcessor;</div><div class="line"><span class="keyword">import</span> com.alibaba.taobao.worker.WorkerTask;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLMatchingProcessor</span> <span class="keyword">implements</span> <span class="title">TaskProcessor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_PATTERN = <span class="string">"http(s)?://[\\w\\.\\/]*(\\.htm|\\.do|\\.html|\\.xhtm|\\.xhtml)"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WorkerTask&lt;?&gt; task)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!(task <span class="keyword">instanceof</span> MapReducePageURLMiningTask))</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Excepted PageURLMiningTask but was: "</span> + task.getClass().getSimpleName());</div><div class="line"></div><div class="line">        MapReducePageURLMiningTask mapReduceURLMiningTask = (MapReducePageURLMiningTask) task;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Matcher matcher = Pattern.compile(URL_PATTERN).matcher(mapReduceURLMiningTask.getPageContent());</div><div class="line">            <span class="keyword">while</span> (matcher.find()) &#123;</div><div class="line">                mapReduceURLMiningTask.addMinedURL(matcher.group());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mapReduceURLMiningTask.setDone(<span class="keyword">true</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            System.err.println(<span class="string">"Error while fetching specified URL: "</span> + mapReduceURLMiningTask.getTargetURL()</div><div class="line">                    + <span class="string">"\nException"</span> + e.toString());</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">synchronized</span> (mapReduceURLMiningTask) &#123;</div><div class="line">                mapReduceURLMiningTask.notifyAll();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>总结，代码中不同的模式，都是基于最基本的Java基础实现，比如队列、Map、List、Set等等，并且总是不经意间用出一些设计模式的简单实现，但是要学会思考、总结，时间的沉淀和深入的思考总有一天会让我们成为大牛。</p>
</div></article></div><div class="block-sidebar column one-fourth"><div class="widget text-content"><p>阿甘，河南人，技术宅，生于1993,12,23。</p>
<ul>
<li>毕业于<a href="http://www.zzuli.edu.cn/">郑州轻工业学院</a></li>
<li>一个努力前进的<a href="https://github.com/978420544/Demo">菜鸟</a></li>
<li>一个默默奋斗的潜力股</li>
<li>向着明天，一步一步的男人</li>
<li>在 <a href="https://github.com/978420544">Github</a> 上积极参与开源社区</li>
</ul>
</div><div class="widget categories"><h3>分类</h3><hr/><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/bug/">Bug笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/">设计模式</a></li></ul></div><div class="widget tags"><h3>标签</h3><hr/><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/bug/">Bug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle/">Gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/simpleblock/">Simpleblock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thread/">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/">生活</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/work/">职场</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/soul/">鸡汤</a></li></ul></div><div class="widget archives"><h3>归档</h3><hr/><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li></ul></div><div class="widget text-content"><p>该博客使用基于 &nbsp;<a href="http://hexo.io">Hexo</a>&nbsp; 的 &nbsp;<a href="https://github.com/jysperm/hexo-theme-simpleblock">simpleblock</a>&nbsp; 主题。博客内容使用 &nbsp;<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn">CC BY-NC-SA 3.0</a>&nbsp; 授权发布。最后生成于 2017-05-09.</p></div></div></div></div><script src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>